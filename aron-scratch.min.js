/*! application-name 2014-10-21 */
function Scratch(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.originData={},this.originPixData=[],this.imgUrl="",this.surfaceColor=[0,0,0],this.radius=10,this.percentage=.5,this.autoClear=!0,this.offAreaRatio=0,this.FuncComplete=function(){},this.FuncScratching=function(){},this.isCompleted=!1,this.borderWidth={top:0,left:0},this.offsetCoord={top:0,left:0},this.paddingWidth={top:0,left:0},this.shape="circle"}function addEventHandler(t,i,a){t.addEventListener?t.addEventListener(i,a,!1):t.attachEvent?t.attachEvent("on"+i,a):t["on"+i]=a}function getTop(t){var i=t.offsetTop;return null!=t.offsetParent&&(i+=getTop(t.offsetParent)),i}function getLeft(t){var i=t.offsetLeft;return null!=t.offsetParent&&(i+=getLeft(t.offsetParent)),i}function isPC(){for(var t=navigator.userAgent,i=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"],a=!0,e=0;i.length>e;e++)if(t.indexOf(i[e])>0){a=!1;break}return a}Scratch.prototype={init:function(t){t?"":t={},this.initData(t),"texts"in t?this.drawText(t.texts):"imgUrl"in t?this.drawImg():this.drawText(),this.bindEvent()},initData:function(t){if("imgUrl"in t?this.imgUrl=t.imgUrl:"","surfaceColor"in t){var i=t.surfaceColor,a=[],e=!0;if(3==i.length||6==i.length){var n=3==i.length?i.split(""):[i[0]+i[1],i[2]+i[3],i[4]+i[5]];n.forEach(function(t,n){return parseInt(t,16)||0==parseInt(t,16)?(a[n]=parseInt(3==i.length?t+t:t,16),void 0):(e=!1,!1)}),e?this.surfaceColor=a:""}}"radius"in t?this.radius=t.radius:"","autoClear"in t?this.autoClear=t.autoClear:"","percentage"in t?this.percentage=t.percentage:"","FuncComplete"in t?this.FuncComplete=t.FuncComplete:"","FuncScratching"in t?this.FuncScratching=t.FuncScratching:"","shape"in t?this.shape=t.shape:"";var s=this.canvas.style.borderLeftWidth,r=this.canvas.style.borderTopWidth;this.borderWidth.left=s?~~s.split("px")[0]:0,this.borderWidth.top=r?~~r.split("px")[0]:0,this.offsetCoord.top=getTop(this.canvas),this.offsetCoord.left=getLeft(this.canvas);var o=this.canvas.style.paddingLeft,h=this.canvas.style.paddingTop;this.paddingWidth.top=r?~~h.split("px")[0]:0,this.paddingWidth.left=s?~~o.split("px")[0]:0},drawImg:function(){var t=this,i=new Image;i.src=this.imgUrl,i.complete?(this.ctx.drawImage(i,0,0),this.drawSurface()):(i.onload=function(){t.ctx.drawImage(i,0,0),t.drawSurface()},i.onerror=function(){window.alert("Image loading failure, please try again!")})},drawText:function(t){var i="black",a="bold 30px Arial",e="Aron原创",n=0,s=0;t?"":t=[{}],this.ctx.textBaseline="top";for(var r=0;t.length>r;r++)n="offsetX"in t[r]?t[r].offsetX:0,s="offsetY"in t[r]?t[r].offsetY:0,this.ctx.fillStyle="fillStyle"in t[r]?t[r].fillStyle:i,this.ctx.font="font"in t[r]?t[r].font:a,this.ctx.fillText("fillText"in t[r]?t[r].fillText:e,n,s);this.drawSurface()},drawSurface:function(){for(var t=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),i=[],a=0;t.data.length>a;a++)i[a]=t.data[a];for(var e=0;this.canvas.width*this.canvas.height>e;e++)t.data[4*e]=this.surfaceColor[0],t.data[4*e+1]=this.surfaceColor[1],t.data[4*e+2]=this.surfaceColor[2],t.data[4*e+3]=255;this.ctx.putImageData(t,0,0),this.originPixData=i,this.originData=t},bindEvent:function(){var t=this,i=isPC(),a=i?"mousemove":"touchmove",e=i?"mouseout":"touchend";addEventHandler(this.canvas,a,function(a){i?"":(a.preventDefault(),a.clientX=a.targetTouches[0].clientX,a.clientY=a.targetTouches[0].clientY);var e=a.clientX-t.borderWidth.left-t.offsetCoord.left-t.paddingWidth.left+window.scrollX,n=a.clientY-t.borderWidth.top-t.offsetCoord.top-t.paddingWidth.top+window.scrollY;"circle"==t.shape?t.setCircleMode(e,n,t.radius):t.setSquareMode(e,n,t.radius),t.ctx.putImageData(t.originData,0,0),t.setOffAreaRatio(),1>t.offAreaRatio?t.FuncScratching():""}),addEventHandler(this.canvas,e,function(){t.checkFinish(.5,function(){t.isCompleted?"":t.FuncComplete()})})},setSquareMode:function(t,i,a){for(var e=t-a;t+a>=e;e++)for(var n=i-a;i+a>=n;n++)this.setOriginPixData(e,n)},setCircleMode:function(t,i,a){for(var e=t-a;t+a>=e;e++)for(var n=i-a;i+a>=n;n++)a>=Math.sqrt(Math.pow(t-e,2)+Math.pow(i-n,2))&&this.setOriginPixData(e,n)},setOriginPixData:function(t,i){var a=4*(i*this.canvas.width+t);return 0>t||t>=this.canvas.width||0>i||i>=this.canvas.height?!1:(this.originData.data[a]=this.originPixData[a],this.originData.data[a+1]=this.originPixData[a+1],this.originData.data[a+2]=this.originPixData[a+2],this.originData.data[a+3]=this.originPixData[a+3],void 0)},setOffAreaRatio:function(){for(var t=0,i=this.canvas.width*this.canvas.height,a=0;i>a;a++)(this.originData.data[4*a]!=this.surfaceColor[0]||this.originData.data[4*a+1]!=this.surfaceColor[1]||this.originData.data[4*a+2]!=this.surfaceColor[2]||255!=this.originData.data[4*a+3])&&t++;this.offAreaRatio=t/i},checkFinish:function(t,i){this.offAreaRatio>this.percentage&&(this.autoClear?(this.clearSurface(),i(),this.isCompleted=!0):1==this.offAreaRatio&&(i(),this.isCompleted=!0))},clearSurface:function(){for(var t=this.canvas.width*this.canvas.height,i=0;t>i;i++)this.originData.data[4*i]=this.originPixData[4*i],this.originData.data[4*i+1]=this.originPixData[4*i+1],this.originData.data[4*i+2]=this.originPixData[4*i+2],this.originData.data[4*i+3]=this.originPixData[4*i+3];this.ctx.putImageData(this.originData,0,0)}};